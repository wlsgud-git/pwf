"use strict";const F=require("react"),o=require("./shared-CGFYrEgQ.js"),u=require("./shared-VEQdJrv0.js"),c=require("livekit-client");function q(e){const t=Object.create(null,{[Symbol.toStringTag]:{value:"Module"}});if(e){for(const n in e)if(n!=="default"){const s=Object.getOwnPropertyDescriptor(e,n);Object.defineProperty(t,n,s.get?s:{enumerable:!0,get:()=>e[n]})}}return t.default=e,Object.freeze(t)}const i=q(F);function U(e){const t=o.useEnsureRoom(e),n=i.useCallback(async()=>{await t.startAudio()},[t]),s=i.useMemo(()=>o.roomAudioPlaybackAllowedObservable(t),[t]),{canPlayAudio:r}=u.useObservableState(s,{canPlayAudio:t.canPlaybackAudio});return{canPlayAudio:r,startAudio:n}}function $(e){const{state:t,dispatch:n}=u.useLayoutContext().pin;return{buttonProps:i.useMemo(()=>{const{className:r}=o.setupClearPinButton();return u.mergeProps(e,{className:r,disabled:!(t!=null&&t.length),onClick:()=>{n&&n({msg:"clear_pin"})}})},[e,n,t])}}function z(e,t){const n=typeof e=="function"?e:t,s=typeof e=="string"?e:void 0,r=o.useRoomContext(),{send:a,messageObservable:p,isSendingObservable:l}=i.useMemo(()=>o.setupDataMessageHandler(r,s,n),[r,s,n]),d=u.useObservableState(p,void 0),m=u.useObservableState(l,!1);return{message:d,send:a,isSending:m}}const K={connect:!0,audio:!1,video:!1};function V(e){const{token:t,serverUrl:n,options:s,room:r,connectOptions:a,connect:p,audio:l,video:d,screen:m,onConnected:g,onDisconnected:b,onError:S,onMediaDeviceFailure:k,onEncryptionError:T,simulateParticipants:R,...M}={...K,...e};s&&r&&o.log.warn("when using a manually created room, the options object will be ignored. set the desired options directly when creating the room instead.");const[f,L]=i.useState(),E=i.useRef(p);i.useEffect(()=>{L(r??new c.Room(s))},[r,JSON.stringify(s,u.roomOptionsStringifyReplacer)]);const j=i.useMemo(()=>{const{className:P}=o.setupLiveKitRoom();return u.mergeProps(M,{className:P})},[M]);return i.useEffect(()=>{if(!f)return;const P=()=>{const v=f.localParticipant;o.log.debug("trying to publish local tracks"),Promise.all([v.setMicrophoneEnabled(!!l,typeof l!="boolean"?l:void 0),v.setCameraEnabled(!!d,typeof d!="boolean"?d:void 0),v.setScreenShareEnabled(!!m,typeof m!="boolean"?m:void 0)]).catch(O=>{o.log.warn(O),S==null||S(O)})},C=(v,O)=>{const J=c.MediaDeviceFailure.getFailure(v);k==null||k(J,O)},A=v=>{T==null||T(v)},x=v=>{b==null||b(v)},D=()=>{g==null||g()};return f.on(c.RoomEvent.SignalConnected,P).on(c.RoomEvent.MediaDevicesError,C).on(c.RoomEvent.EncryptionError,A).on(c.RoomEvent.Disconnected,x).on(c.RoomEvent.Connected,D),()=>{f.off(c.RoomEvent.SignalConnected,P).off(c.RoomEvent.MediaDevicesError,C).off(c.RoomEvent.EncryptionError,A).off(c.RoomEvent.Disconnected,x).off(c.RoomEvent.Connected,D)}},[f,l,d,m,S,T,k,g,b]),i.useEffect(()=>{if(f){if(R){f.simulateParticipants({participants:{count:R},publish:{audio:!0,useRealTracks:!0}});return}if(p){if(E.current=!0,o.log.debug("connecting"),!t){o.log.debug("no token yet");return}if(!n){o.log.warn("no livekit url provided"),S==null||S(Error("no livekit url provided"));return}f.connect(n,t,a).catch(P=>{o.log.warn(P),E.current===!0&&(S==null||S(P))})}else o.log.debug("disconnecting because connect is false"),E.current=!1,f.disconnect()}},[p,t,JSON.stringify(a),f,S,n,R]),i.useEffect(()=>{if(f)return()=>{o.log.info("disconnecting on onmount"),f.disconnect()}},[f]),{room:f,htmlProps:j}}function G(e={}){let t=u.useMaybeParticipantContext();e.participant&&(t=e.participant);const n=i.useMemo(()=>o.participantInfoObserver(t),[t]),{identity:s,name:r,metadata:a}=u.useObservableState(n,{name:t==null?void 0:t.name,identity:t==null?void 0:t.identity,metadata:t==null?void 0:t.metadata});return{identity:s,name:r,metadata:a}}function W(e={}){const t=u.useEnsureParticipant(e.participant),n=i.useMemo(()=>o.participantPermissionObserver(t),[t]);return u.useObservableState(n,t.permissions)}function y(e={}){const t=o.useEnsureRoom(e.room),[n,s]=i.useState([]);return i.useEffect(()=>{const r=o.connectedParticipantsObserver(t,{additionalRoomEvents:e.updateOnlyOn}).subscribe(s);return()=>r.unsubscribe()},[t,JSON.stringify(e.updateOnlyOn)]),n}function H(e={}){const t=y(e),{localParticipant:n}=o.useLocalParticipant(e);return i.useMemo(()=>[n,...t],[n,t])}function Q(e,t={}){const n=o.useRoomContext(),[s]=i.useState(t.updateOnlyOn),r=i.useMemo(()=>typeof e=="string"?o.connectedParticipantObserver(n,e,{additionalEvents:s}):o.participantByIdentifierObserver(n,e,{additionalEvents:s}),[n,JSON.stringify(e),s]),[a,p]=i.useState({p:void 0});return i.useEffect(()=>{const l=r.subscribe(d=>p({p:d}));return()=>l.unsubscribe()},[r]),a.p}function X(e={}){const t=o.useEnsureRoom(e.room),n=i.useMemo(()=>o.roomInfoObserver(t),[t]),{name:s,metadata:r}=u.useObservableState(n,{name:t.name,metadata:t.metadata});return{name:s,metadata:r}}function N(){const e=o.useRoomContext(),t=i.useMemo(()=>o.activeSpeakerObserver(e),[e]);return u.useObservableState(t,e.activeSpeakers)}function Y(e){const[t,n]=i.useState(o.sortParticipants(e)),s=N();return i.useEffect(()=>{n(o.sortParticipants(e))},[s,e]),t}function Z(e,t,n={}){const[s,r]=i.useState(void 0);return i.useEffect(()=>{var p;if(e===void 0)throw Error("token endpoint needs to be defined");if(((p=n.userInfo)==null?void 0:p.identity)===void 0)return;(async()=>{o.log.debug("fetching token");const l=new URLSearchParams({...n.userInfo,roomName:t}),d=await fetch(`${e}?${l.toString()}`);if(!d.ok){o.log.error(`Could not fetch token. Server responded with status ${d.status}: ${d.statusText}`);return}const{accessToken:m}=await d.json();r(m)})()},[e,t,JSON.stringify(n)]),s}function ee(e){const[t,n]=i.useState(o.getTrackByIdentifier(e)),{trackObserver:s}=i.useMemo(()=>o.setupMediaTrack(e),[e.participant.sid??e.participant.identity,e.source]);return i.useEffect(()=>{const r=s.subscribe(a=>{n(a)});return()=>r==null?void 0:r.unsubscribe()},[s]),{participant:e.participant,source:e.source??c.Track.Source.Unknown,publication:t}}function te(e,t){const n=u.useEnsureParticipant(t);return ee({name:e,participant:n})}function h(e,t){const n=u.useMaybeParticipantContext(),s=y({updateOnlyOn:[]}),r=i.useMemo(()=>t?s.find(l=>l.identity===t):n,[t,s,n]),a=i.useMemo(()=>{if(r)return o.participantTracksObservable(r,{sources:e})},[r,JSON.stringify(e)]);return u.useObservableState(a,[])}function ne(e){var n,s,r;const t=i.useMemo(()=>{var a;return(a=e==null?void 0:e.publication)!=null&&a.track?o.trackSyncTimeObserver(e==null?void 0:e.publication.track):void 0},[(n=e==null?void 0:e.publication)==null?void 0:n.track]);return u.useObservableState(t,{timestamp:Date.now(),rtpTimestamp:(r=(s=e==null?void 0:e.publication)==null?void 0:s.track)==null?void 0:r.rtpTimestamp})}const se={bufferSize:100};function I(e,t){const n={...se,...t},[s,r]=i.useState([]),a=ne(e),p=l=>{var d;(d=n.onTranscription)==null||d.call(n,l),r(m=>o.dedupeSegments(m,l.map(g=>o.addMediaTimestampToTranscription(g,a)),n.bufferSize))};return i.useEffect(()=>{if(!(e!=null&&e.publication))return;const l=o.trackTranscriptionObserver(e.publication).subscribe(d=>{p(...d)});return()=>{l.unsubscribe()}},[e&&o.getTrackReferenceId(e),p]),{segments:s}}function _(e={}){const t=u.useMaybeParticipantContext(),n=e.participant??t,s=i.useMemo(()=>o.participantAttributesObserver(n),[n]);return u.useObservableState(s,{attributes:n==null?void 0:n.attributes})}function oe(e,t={}){const n=u.useEnsureParticipant(t.participant),[s,r]=i.useState(n.attributes[e]);return i.useEffect(()=>{if(!n)return;const a=o.participantAttributesObserver(n).subscribe(p=>{p.changed[e]!==void 0&&r(p.attributes[e])});return()=>{a.unsubscribe()}},[n,e]),s}const w="lk.agent.state";function re(){const e=y(),t=e.find(b=>b.kind===c.ParticipantKind.AGENT&&!("lk.publish_on_behalf"in b.attributes)),n=e.find(b=>b.kind===c.ParticipantKind.AGENT&&b.attributes["lk.publish_on_behalf"]===(t==null?void 0:t.identity)),s=h([c.Track.Source.Microphone,c.Track.Source.Camera],t==null?void 0:t.identity),r=h([c.Track.Source.Microphone,c.Track.Source.Camera],n==null?void 0:n.identity),a=s.find(b=>b.source===c.Track.Source.Microphone)??r.find(b=>b.source===c.Track.Source.Microphone),p=s.find(b=>b.source===c.Track.Source.Camera)??r.find(b=>b.source===c.Track.Source.Camera),{segments:l}=I(a),d=u.useConnectionState(),{attributes:m}=_({participant:t}),g=i.useMemo(()=>d===c.ConnectionState.Disconnected?"disconnected":d===c.ConnectionState.Connecting||!t||!(m!=null&&m[w])?"connecting":m[w],[m,t,d]);return{agent:t,state:g,audioTrack:a,videoTrack:p,agentTranscriptions:l,agentAttributes:m}}function ie(e){const t=o.useEnsureRoom(e),n=u.useConnectionState(t),s=i.useMemo(()=>o.recordingStatusObservable(t),[t,n]);return u.useObservableState(s,t.isRecording)}function B(e){const t=o.useRoomContext(),s=u.useConnectionState(t)===c.ConnectionState.Disconnected,r=i.useMemo(()=>o.setupTextStream(t,e),[t,e]),a=s?void 0:r;return{textStreams:u.useObservableState(a,[])}}function ae(e){const{participantIdentities:t,trackSids:n}=e??{},{textStreams:s}=B(o.DataTopic.TRANSCRIPTION);return i.useMemo(()=>s.filter(a=>t?t.includes(a.participantInfo.identity):!0).filter(a=>{var p;return n?n.includes(((p=a.streamInfo.attributes)==null?void 0:p["lk.transcribed_track_id"])??""):!0}),[s,t,n])}exports.useAudioPlayback=U;exports.useClearPinButton=$;exports.useDataChannel=z;exports.useIsRecording=ie;exports.useLiveKitRoom=V;exports.useParticipantAttribute=oe;exports.useParticipantAttributes=_;exports.useParticipantInfo=G;exports.useParticipantPermissions=W;exports.useParticipantTracks=h;exports.useParticipants=H;exports.useRemoteParticipant=Q;exports.useRemoteParticipants=y;exports.useRoomInfo=X;exports.useSortedParticipants=Y;exports.useSpeakingParticipants=N;exports.useTextStream=B;exports.useToken=Z;exports.useTrackByName=te;exports.useTrackTranscription=I;exports.useTranscriptions=ae;exports.useVoiceAssistant=re;
//# sourceMappingURL=shared-BpdYlR3A.js.map
